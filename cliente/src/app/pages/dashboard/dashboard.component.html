<div class="page-wrapper">
  <app-loged-header [fotoPerfilUrl]="fotoPerfilUrl"></app-loged-header>

  <main>
    <div class="container-fluid">
      <div class="welcome-banner">
        <h1>¡Bienvenid&#64; de nuevo, {{ usuario }}!</h1>
      </div>

      <!-- Modal Crear Menú SIEMPRE disponible -->
      <app-crear-menu-modal
        *ngIf="mostrarCrearMenuModal"
        (crear)="onCrearMenu($event)"
        (cancelar)="cerrarCrearMenuModal()"
      ></app-crear-menu-modal>

      <!-- Contenedor cuando NO hay menús -->
      <div *ngIf="menus.length === 0">
        <div class="container-fluid empty-menu-box mb-3">
          <h2 class="text-center">¡Sin recetas!</h2>
        </div>
        <ng-container *ngIf="prefs.length === 0">
          <div class="container-fluid empty-menu-box">
            <p class="text-center">
              Para empezar a crear tu menú te recomendamos añadir marcar tu meta
              calculando tus calorías de mantenimiento.<br />
              <a routerLink="/calculadora" class="btn btn-primary mt-3"
                >Ir a Calculadora</a
              >
            </p>
          </div>
        </ng-container>
        <div *ngIf="mostrarMsgGenerarMenu">
          <div
            *ngIf="prefs.length === 0"
            class="text-center mt-2 text-danger fw-bold"
          >
            PRIMERO DEBES IR A LA CALCULADORA
          </div>
          <div
            *ngIf="prefs.length > 0"
            class="text-center mt-2 text-success fw-bold"
          >
            TODO OK
          </div>
        </div>
      </div>

      <!-- Contenedor cuando SÍ hay menús -->
      <div *ngIf="menus.length > 0">
        <!-- Tarjetas de Nutrición -->
        <div class="row nutrition-info">
          <!-- Calorías -->
          <div class="col-md-3 col-sm-6">
            <div class="nutrition-card">
              <div class="nutrition-label">Calorías</div>
              <div class="nutrition-wrapper">
                <p class="nutrition-value">0</p>
                <p class="nutrition-goal">
                  /{{ totalesMenu.calorias | number : "1.0-0" }}
                </p>
              </div>
              <div class="progress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width]="
                    (totalesMenu.calorias > 0 && prefs?.calorias_objetivo
                      ? (0 / totalesMenu.calorias) * 100
                      : 0) + '%'
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- Proteínas -->
          <div class="col-md-3 col-sm-6">
            <div class="nutrition-card">
              <div class="nutrition-label">Proteínas</div>
              <div class="nutrition-wrapper">
                <p class="nutrition-value">0</p>
                <p class="nutrition-goal">
                  /{{ totalesMenu.proteinas | number : "1.0-0" }}
                </p>
              </div>
              <div class="progress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width]="
                    (totalesMenu.proteinas > 0 && prefs?.proteinas_objetivo
                      ? (0 / totalesMenu.proteinas) * 100
                      : 0) + '%'
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- Carbohidratos -->
          <div class="col-md-3 col-sm-6">
            <div class="nutrition-card">
              <div class="nutrition-label">Carbohidratos</div>
              <div class="nutrition-wrapper">
                <p class="nutrition-value">0</p>
                <p class="nutrition-goal">
                  /{{ totalesMenu.carbohidratos | number : "1.0-0" }}
                </p>
              </div>
              <div class="progress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width]="
                    (totalesMenu.carbohidratos > 0 &&
                    prefs?.carbohidratos_objetivo
                      ? (0 / totalesMenu.carbohidratos) * 100
                      : 0) + '%'
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- Grasas -->
          <div class="col-md-3 col-sm-6">
            <div class="nutrition-card">
              <div class="nutrition-label">Grasas</div>
              <div class="nutrition-wrapper">
                <p class="nutrition-value">0</p>
                <p class="nutrition-goal">
                  /{{ totalesMenu.grasas | number : "1.0-0" }}
                </p>
              </div>
              <div class="progress">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width]="
                    (totalesMenu.grasas > 0 && prefs?.grasas_objetivo
                      ? (0 / totalesMenu.grasas) * 100
                      : 0) + '%'
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Plan Personalizado -->
        <h2 class="section-title">Tu plan personalizado</h2>

        <div class="tabs-container">
          <!-- Pestañas -->
          <div class="d-flex mb-4 plan-bar">
            <button class="tab-button active">Diario</button>
            <button class="tab-button">Semanal</button>
            <button class="tab-button">Personalizado</button>
          </div>

          <!-- Tarjetas de Comidas -->
          <div class="row recetas">
            <div
              class="col-md-4 mb-4 receta-card"
              *ngFor="let receta of recetasMenu"
            >
              <div class="card">
                <img
                  [src]="receta.imagen"
                  class="card-img-top"
                  [alt]="receta.nombre"
                />
                <div class="card-body">
                  <h5 class="card-title">{{ receta.nombre }}</h5>
                  <p class="card-text">
                    <small class="text-muted">
                      <i class="bi bi-clock"></i>
                      {{ receta.tiempo_preparacion }}
                      <i class="bi bi-fire ms-2"></i> {{ receta.calorias }} kcal
                    </small>
                  </p>
                  <a
                    href="#"
                    class="btn btn-primary"
                    (click)="$event.preventDefault(); abrirVerReceta(receta)"
                    >Ver Receta</a
                  >
                  <button
                    class="btn btn-outline-danger float-end"
                    (click)="abrirModalTerminar(receta)"
                  >
                    Terminar
                  </button>
                </div>
              </div>
            </div>
            <ng-template #sinRecetas>
              <div class="col-12 text-center">
                <p>No tienes recetas en tu menú.</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
    <!-- Botones siempre visibles debajo del contenido principal, dentro de main -->
    <div class="d-flex justify-content-center gap-3 mt-5 mb-4">
      <button
        type="button"
        class="btn btn-primary"
        (click)="
          abrirCrearMenuModal();
          $event.stopPropagation();
          $event.preventDefault()
        "
      >
        Crear Menú
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="
          mostrarMsgGenerarMenu = true;
          $event.stopPropagation();
          $event.preventDefault()
        "
      >
        Generar menú
      </button>
    </div>
  </main>

  <!-- Modal de confirmación para terminar receta -->
  <div
    class="modal fade"
    tabindex="-1"
    [class.show]="mostrarModalTerminar"
    [style.display]="mostrarModalTerminar ? 'block' : 'none'"
    style="background: rgba(0, 0, 0, 0.4)"
    *ngIf="mostrarModalTerminar"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <i
          class="bi bi-exclamation-triangle text-danger"
          style="font-size: 2.5rem"
        ></i>
        <h4 class="mt-3">¿Estás seguro que quieres terminar la receta?</h4>
        <div class="d-flex justify-content-center gap-3 mt-4">
          <button class="btn btn-secondary" (click)="cerrarModalTerminar()">
            Cancelar
          </button>
          <button class="btn btn-danger" (click)="cerrarModalTerminar()">
            Terminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</div>
